<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atrix - Palm Reading</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">

    <style>
        /* Additional styles for quiz functionality */
        body {
            background: #1a1a2e;
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #657BFF;
        }

        .error-message {
            display: none;
            background-color: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .success-message {
            display: none;
            background-color: #51cf66;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .quiz-container {
            background: #272a3e;
            padding: 30px;
            border-radius: 10px;
            margin: 20px auto;
            text-align: left;
            max-width: 800px;
        }

        .quiz-step {
            margin-bottom: 20px;
            color: white;
        }

        .quiz-step h2 {
            color: #657BFF;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .quiz-step p {
            color: #e0e0e0;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .quiz-options {
            margin: 15px 0;
        }

        .quiz-option {
            display: block;
            background: #1a1a2e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            color: white;
            border: 2px solid transparent;
        }

        .quiz-option:hover {
            background: #2a2a3e;
            border-color: #657BFF;
        }

        .quiz-option input {
            margin-right: 10px;
        }

        .quiz-progress {
            margin: 20px 0;
            text-align: center;
            color: white;
        }

        .quiz-progress p {
            color: #657BFF;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #1a1a2e;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #657BFF 0%, #9D7FFF 100%);
            transition: width 0.3s;
        }

        #quizContainer {
            min-height: 400px;
            padding: 20px;
        }

        #resultsContainer {
            min-height: 400px;
            padding: 20px;
            color: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è input –ø–æ–ª–µ–π */
        input[type="email"],
        input[type="date"] {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #444;
            background: #1a1a2e;
            color: white;
            font-size: 16px;
        }

        input[type="email"]::placeholder,
        input[type="date"]::placeholder {
            color: #888;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .predirect {
            background: linear-gradient(135deg, #657BFF 0%, #9D7FFF 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 20px;
        }

        .predirect:hover {
            transform: scale(1.05);
        }

        .predirect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<nav class="sidebar-menu">
    <button class="close-btn">X</button>
    <ul>
        <li><a href="mailto:atrix.app@support-team.app">Contact us</a></li>
        <li><a href="Privacy.html">Privacy Policy</a></li>
        <li><a href="TermsOfUse.html">Terms of Use</a></li>
        <li><a href="Billing.html">Billing Terms</a></li>
        <li><a href="Money.html">Money-Back Policy</a></li>
        <li><a href="login.html">My Account</a></li>
    </ul>
</nav>

<button class="hamburger-menu" aria-label="Menu Toggle">
    <i class="bi bi-list"></i>
</button>

<div class="container">
    <h1 class="head">Get palm predictions and know <br>yourself better</h1>
    <img src="img/Image.png" alt="Palm Reading Illustration" id="palmImage">

    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator">
        <p>Starting your palm reading journey...</p>
    </div>

    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage"></div>

    <!-- Predict Button -->
    <button type="button" class="predirect" id="startQuizBtn">
        Predict Now
    </button>

    <!-- Quiz Container (hidden by default) -->
    <div id="quizContainer" style="display: none;"></div>

    <!-- Results Container (hidden by default) -->
    <div id="resultsContainer" style="display: none;"></div>

    <!-- Additional Info -->
    <div class="info-section">
        <p class="info-text">üîÆ Discover your future through palm reading</p>
        <p class="info-text">‚≠ê Personalized insights based on your answers</p>
        <p class="info-text">üéØ 2-minute quiz for accurate predictions</p>
    </div>
</div>

<script>
    // API functions
    const API_BASE = '/api';

    async function startQuiz(utmParams = {}) {
        const response = await fetch(`${API_BASE}/quiz/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(utmParams)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Start quiz response:', result);

        if (!result.success) {
            throw new Error(result.error || 'Failed to start quiz');
        }

        return result.data || result;
    }

    async function getQuizStep(sessionId) {
        const response = await fetch(`${API_BASE}/quiz/${sessionId}/step`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Failed to get quiz step');
        }

        return result.data || result;
    }

    async function submitAnswer(sessionId, stepId, answer) {
        const response = await fetch(`${API_BASE}/quiz/${sessionId}/answer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stepId: stepId,
                answer: answer
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Failed to submit answer');
        }

        return result.data || result;
    }

    async function getQuizResults(sessionId) {
        const response = await fetch(`${API_BASE}/quiz/${sessionId}/results`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Failed to get results');
        }

        return result.data || result;
    }

    // Main application logic
    document.addEventListener('DOMContentLoaded', function() {
        const menuButton = document.querySelector('.hamburger-menu');
        const sidebar = document.querySelector('.sidebar-menu');
        const closeButton = document.querySelector('.close-btn');
        const body = document.body;
        const startQuizBtn = document.getElementById('startQuizBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const quizContainer = document.getElementById('quizContainer');
        const resultsContainer = document.getElementById('resultsContainer');

        // Menu functionality
        menuButton.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            body.classList.toggle('menu-open');
        });

        closeButton.addEventListener('click', function() {
            sidebar.classList.remove('open');
            body.classList.remove('menu-open');
        });

        body.addEventListener('click', function(e) {
            if (e.target === body && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                body.classList.remove('menu-open');
            }
        });

        // Quiz functionality
        startQuizBtn.addEventListener('click', async function() {
            await startQuizFlow();
        });

        async function startQuizFlow() {
            console.log('Starting quiz flow...');

            // Show loading
            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            startQuizBtn.disabled = true;

            try {
                // Get UTM parameters from URL
                const urlParams = new URLSearchParams(window.location.search);
                const utmParams = {
                    utmSource: urlParams.get('utm_source') || urlParams.get('utmSource'),
                    utmCampaign: urlParams.get('utm_campaign') || urlParams.get('utmCampaign'),
                    utmMedium: urlParams.get('utm_medium') || urlParams.get('utmMedium'),
                    utmContent: urlParams.get('utm_content') || urlParams.get('utmContent'),
                    utmTerm: urlParams.get('utm_term') || urlParams.get('utmTerm'),
                    adId: urlParams.get('ad_id'),
                    adName: urlParams.get('ad_name'),
                    adPlacement: urlParams.get('ad_placement'),
                    adSubnetwork: urlParams.get('ad_subnetwork'),
                    adsetId: urlParams.get('adset_id'),
                    adsetName: urlParams.get('adset_name'),
                    campaignId: urlParams.get('campaign_id'),
                    campaignName: urlParams.get('campaign_name'),
                    creativeTopic: urlParams.get('creative_topic'),
                    fbclid: urlParams.get('fbclid'),
                    idfm: urlParams.get('idfm'),
                    mode: urlParams.get('mode') || 'welcome'
                };

                console.log('Starting quiz with params:', utmParams);

                // Start quiz via API
                const quizSession = await startQuiz(utmParams);
                console.log('Quiz session created:', quizSession);
                console.log('Session ID:', quizSession.sessionId);

                // Hide loading
                loadingIndicator.style.display = 'none';

                // Hide main content and show quiz
                const container = document.querySelector('.container');
                console.log('Container found:', !!container);
                console.log('Quiz container found:', !!quizContainer);

                if (!container || !quizContainer) {
                    throw new Error('Required DOM elements not found');
                }

                console.log('Hiding container, showing quiz...');
                container.style.display = 'none';
                quizContainer.style.display = 'block';
                console.log('Container hidden, quiz shown');

                // Start the quiz steps
                console.log('About to load quiz step...');
                await loadQuizStep(quizSession.sessionId);
                console.log('Quiz step loaded');

            } catch (error) {
                console.error('Failed to start quiz:', error);
                console.error('Error stack:', error.stack);
                errorMessage.textContent = 'Failed to start quiz: ' + error.message;
                errorMessage.style.display = 'block';
                loadingIndicator.style.display = 'none';
                startQuizBtn.disabled = false;
            }
        }

        async function loadQuizStep(sessionId) {
            try {
                const stepData = await getQuizStep(sessionId);
                displayQuizStep(sessionId, stepData);
            } catch (error) {
                console.error('Failed to load quiz step:', error);
                showError('Failed to load quiz: ' + error.message);
            }
        }

        function displayQuizStep(sessionId, stepData) {
            const step = stepData.step;
            const progress = stepData.progress;

            let stepHTML = `
                    <div class="quiz-progress">
                        <p>Question ${progress.current} of ${progress.total}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(progress.current / progress.total) * 100}%"></div>
                        </div>
                    </div>
                    <div class="quiz-step">
                `;

            if (step.type === 'intro') {
                stepHTML += `
                        <h2>${step.title}</h2>
                        <p>${step.description}</p>
                        <button class="predirect" onclick="handleIntroStep('${sessionId}')">
                            ${step.button || 'Start Quiz'}
                        </button>
                    `;
            } else if (step.type === 'multiple_choice') {
                stepHTML += `
                        <h2>${step.question}</h2>
                        ${step.description ? `<p>${step.description}</p>` : ''}
                        <div class="quiz-options">
                            ${step.options.map(option => `
                                <label class="quiz-option">
                                    <input type="radio" name="quizOption" value="${option.id}">
                                    ${option.icon ? `${option.icon} ` : ''}${option.text}
                                </label>
                            `).join('')}
                        </div>
                        <button class="predirect" onclick="handleMultipleChoice('${sessionId}', '${step.id}')">
                            Continue
                        </button>
                    `;
            } else if (step.type === 'email') {
                stepHTML += `
                        <h2>${step.question}</h2>
                        <p>${step.description}</p>
                        <input type="email" id="emailInput" placeholder="${step.placeholder || 'Enter your email'}"
                               style="width: 100%; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #1a1a2e; color: white;">
                        <button class="predirect" onclick="handleEmailStep('${sessionId}', '${step.id}')">
                            ${step.button || 'Get My Results'}
                        </button>
                    `;
            }

            stepHTML += `</div>`;
            quizContainer.innerHTML = stepHTML;
        }

        // Global functions for button handlers
        window.handleIntroStep = async function(sessionId) {
            await loadQuizStep(sessionId);
        };

        window.handleMultipleChoice = async function(sessionId, stepId) {
            const selectedOption = document.querySelector('input[name="quizOption"]:checked');
            if (!selectedOption) {
                alert('Please select an option');
                return;
            }

            await submitAnswerAndContinue(sessionId, stepId, selectedOption.value);
        };

        window.handleEmailStep = async function(sessionId, stepId) {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();

            if (!email || !isValidEmail(email)) {
                alert('Please enter a valid email address');
                return;
            }

            await submitAnswerAndContinue(sessionId, stepId, email);
        };

        async function submitAnswerAndContinue(sessionId, stepId, answer) {
            try {
                const result = await submitAnswer(sessionId, stepId, answer);

                if (result.nextStep) {
                    // Load next step
                    await loadQuizStep(sessionId);
                } else {
                    // Quiz completed, show results
                    await showResults(sessionId);
                }
            } catch (error) {
                console.error('Failed to submit answer:', error);
                showError('Failed to submit answer: ' + error.message);
            }
        }

        async function showResults(sessionId) {
            try {
                const results = await getQuizResults(sessionId);

                quizContainer.style.display = 'none';
                resultsContainer.style.display = 'block';

                const resultsHTML = `
                        <div class="quiz-container">
                            <h2 style="color: #657BFF; text-align: center;">Your Palm Reading Results</h2>
                            <p style="text-align: center;">Based on your answers, here are your personalized insights:</p>

                            <div style="margin-top: 30px;">
                                <h3>üåü Key Predictions:</h3>
                                <ul>
                                    <li>Strong intuition and emotional intelligence revealed in your palm lines</li>
                                    <li>Creative potential waiting to be unlocked in the coming months</li>
                                    <li>Natural leadership abilities indicated by your hand shape</li>
                                </ul>

                                <h3>üí´ Life Path Insights:</h3>
                                <ul>
                                    <li>Meaningful relationships will blossom in the next year</li>
                                    <li>Career opportunities aligned with your true passions</li>
                                    <li>Financial stability through creative endeavors</li>
                                </ul>

                                <h3>üîÆ Recommendations:</h3>
                                <ul>
                                    <li>Practice daily meditation (10 minutes) to enhance intuition</li>
                                    <li>Explore creative hobbies to unlock hidden talents</li>
                                    <li>Trust your instincts in important decisions</li>
                                    <li>Network with like-minded individuals for growth</li>
                                </ul>
                            </div>

                            ${results.personalLink ? `
                                <div style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center;">
                                    <p>Your personal access link:</p>
                                    <a href="${results.personalLink}" style="color: #657BFF; font-size: 16px; text-decoration: none;">
                                        ${results.personalLink}
                                    </a>
                                </div>
                            ` : ''}

                            <button class="predirect" onclick="location.reload()" style="margin-top: 20px;">
                                Start New Reading
                            </button>
                        </div>
                    `;

                resultsContainer.innerHTML = resultsHTML;

            } catch (error) {
                console.error('Failed to get results:', error);
                showError('Failed to get results: ' + error.message);
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            loadingIndicator.style.display = 'none';
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Check if we have UTM parameters and log them
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.toString()) {
            console.log('UTM Parameters detected:', Object.fromEntries(urlParams));
        }
    });
</script>
</body>
</html>